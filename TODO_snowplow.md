https://github.com/dumkydewilde/snowplow-serverless/tree/main
https://docs.snowplow.io/docs/collecting-data/collecting-from-own-applications/snowplow-tracker-protocol/
https://github.com/snowplow/iglu-central/tree/master/schemas/com.snowplowanalytics.snowplow
https://github.com/snowplow/iglu-central/blob/ece55d485f69ab5bfb31a71db312dd74f817f9cd/schemas/com.snowplowanalytics.snowplow/atomic/jsonschema/1-0-0#L443

{
    "schema": "iglu:com.snowplowanalytics.snowplow/payload_data/jsonschema/1-0-4",
    "data": [
        {
            "vp": "1284x2778",
            "eid": "26B8A6DB-3093-4B55-B7EC-FFBA788F8193",
            "p": "mob",
            "cx": "eyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93cGxvd2FuYWx5dGljcy5zbm93cGxvd1wvY29udGV4dHNcL2pzb25zY2hlbWFcLzEtMC0xIiwiZGF0YSI6W3sic2NoZW1hIjoiaWdsdTpjb20uc25vd3Bsb3dhbmFseXRpY3Muc25vd3Bsb3dcL21vYmlsZV9jb250ZXh0XC9qc29uc2NoZW1hXC8xLTAtMiIsImRhdGEiOnsicGh5c2ljYWxNZW1vcnkiOjU4OTk0MDMyNjQsImJhdHRlcnlMZXZlbCI6NTIsImJhdHRlcnlTdGF0ZSI6InVucGx1Z2dlZCIsIm9zVmVyc2lvbiI6IjE2LjUuMSIsImFwcEF2YWlsYWJsZU1lbW9yeSI6MzE3NTQzMDg0OCwibmV0d29ya1R5cGUiOiJ3aWZpIiwib3NUeXBlIjoiaW9zIiwiZGV2aWNlTW9kZWwiOiJpUGhvbmUxNCwzIiwidG90YWxTdG9yYWdlIjoxMjc4NzcyNzE1NTIsImxvd1Bvd2VyTW9kZSI6ZmFsc2UsImRldmljZU1hbnVmYWN0dXJlciI6IkFwcGxlIEluYy4iLCJhdmFpbGFibGVTdG9yYWdlIjo1MzMzOTYxOTMyOH19LHsic2NoZW1hIjoiaWdsdTpjb20uc25vd3Bsb3dhbmFseXRpY3MubW9iaWxlXC9hcHBsaWNhdGlvblwvanNvbnNjaGVtYVwvMS0wLTAiLCJkYXRhIjp7ImJ1aWxkIjoiNDE3NTQ5IiwidmVyc2lvbiI6IjIuNjAuMCJ9fSx7InNjaGVtYSI6ImlnbHU6Y29tLnNub3dwbG93YW5hbHl0aWNzLnNub3dwbG93XC9jbGllbnRfc2Vzc2lvblwvanNvbnNjaGVtYVwvMS0wLTIiLCJkYXRhIjp7InVzZXJJZCI6IjAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCIsInN0b3JhZ2VNZWNoYW5pc20iOiJMT0NBTF9TVE9SQUdFIiwic2Vzc2lvbkluZGV4IjoyMSwicHJldmlvdXNTZXNzaW9uSWQiOm51bGwsInNlc3Npb25JZCI6ImQxODIzZTFjLTMyY2UtNDI0ZS1iOGVjLTEwZjkyM2NjODE0MCIsImZpcnN0RXZlbnRJZCI6IjI2QjhBNkRCLTMwOTMtNEI1NS1CN0VDLUZGQkE3ODhGODE5MyIsImV2ZW50SW5kZXgiOjEsImZpcnN0RXZlbnRUaW1lc3RhbXAiOiIyMDIzLTA2LTIzVDEzOjM3OjMwLjU1N1oifX0seyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93cGxvd2FuYWx5dGljcy5tb2JpbGVcL3NjcmVlblwvanNvbnNjaGVtYVwvMS0wLTAiLCJkYXRhIjp7Im5hbWUiOiJMb2dpbkFjY2Vzc0NvZGUiLCJpZCI6IkUzREFGRkU1LUY2MkYtNDBFOC1COTRCLUJEQzQxNTkxOUNCOCJ9fSx7InNjaGVtYSI6ImlnbHU6Y29tLnNub3dwbG93YW5hbHl0aWNzLm1vYmlsZVwvYXBwbGljYXRpb25fbGlmZWN5Y2xlXC9qc29uc2NoZW1hXC8xLTAtMCIsImRhdGEiOnsiaXNWaXNpYmxlIjp0cnVlfX1dfQ",
            "tz": "Europe/Paris",
            "stm": "1687527450562",
            "dtm": "1687527450557",
            "tv": "ios-4.1.0 rn-1.4.0",
            "tna": "mobileAppTracker",
            "ue_px": "eyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93cGxvd2FuYWx5dGljcy5zbm93cGxvd1wvdW5zdHJ1Y3RfZXZlbnRcL2pzb25zY2hlbWFcLzEtMC0wIiwiZGF0YSI6eyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93cGxvd2FuYWx5dGljcy5tb2JpbGVcL3NjcmVlbl92aWV3XC9qc29uc2NoZW1hXC8xLTAtMCIsImRhdGEiOnsibmFtZSI6IkxvZ2luQWNjZXNzQ29kZSIsImlkIjoiRTNEQUZGRTUtRjYyRi00MEU4LUI5NEItQkRDNDE1OTE5Q0I4In19fQ",
            "e": "ue",
            "lang": "fr-FR",
            "aid": "com.fpe.comptenickel",
            "res": "1284x2778"
        }
    ]
}



with source as (

select r'''
{
    "schema": "iglu:com.snowplowanalytics.snowplow\/contexts\/jsonschema\/1-0-1",
    "data": [
        {
            "schema": "iglu:com.snowplowanalytics.snowplow\/mobile_context\/jsonschema\/1-0-2",
            "data": {
                "physicalMemory": 4036788224,
                "appleIdfv": "1905FDA8-FC9A-42AB-A265-438414E62CB7",
                "batteryLevel": 20,
                "batteryState": "unplugged",
                "osVersion": "15.6.1",
                "appAvailableMemory": 2120989616,
                "networkType": "wifi",
                "osType": "ios",
                "deviceModel": "iPhone12,1",
                "totalStorage": 63933894656,
                "lowPowerMode": false,
                "deviceManufacturer": "Apple Inc.",
                "availableStorage": 6563741696
            }
        },
        {
            "schema": "iglu:com.snowplowanalytics.mobile\/application\/jsonschema\/1-0-0",
            "data": {
                "build": "417549",
                "version": "2.60.0"
            }
        }
    ]
}
'''
as content

)

select
    (
        select struct(
            json_extract(item, '$.data.physicalMemory') as physicalMemory,
            json_extract(item, '$.data.batteryLevel') as batteryLevel
        )
        from unnest(json_extract_array(content, '$.data')) item
        where json_value(item, '$.schema') = 'iglu:com.snowplowanalytics.snowplow/mobile_context/jsonschema/1-0-2'
    ) as mobile_context
from source

