type: procedure
category: explore
author:
  name: Paul Marcombes
  url: https://www.linkedin.com/in/paul-marcombes
  avatar_url: "https://lh3.googleusercontent.com/a-/ACB-R5RDf2yxcw1p_IYLCKmiUIScreatDdhG8B83om6Ohw=s260"
description: |
  Show column statistics

  ??? example "See the result as a data visualization in BigQuery Console!"

      The result of this function can be vizualized as an html report directly in BigQuery Console.
      To do so, you will have to:

      - Install this bookmarklet: <a href="javascript:(function()%7Blet%20isChartJsLoaded%20%3D%20false%3B%0A%0A%0Aconst%20escapeHTML%20%3D%20function(html)%20%7B%0A%20%20if(!trustedTypes)%20%7B%0A%20%20%20%20return%20html%3B%0A%20%20%7D%0A%20%20const%20policy%20%3D%20trustedTypes.createPolicy(%22forceInner%22%2C%20%7BcreateHTML%3A%20(to_escape)%20%3D%3E%20to_escape%7D)%3B%0A%20%20return%20policy.createHTML(html)%3B%0A%7D%3B%0A%0A%0Aconst%20escapeScript%20%3D%20function(script)%20%7B%0A%20%20if(!trustedTypes)%20%7B%0A%20%20%20%20return%20script%3B%0A%20%20%7D%0A%20%20const%20policy%20%3D%20trustedTypes.createPolicy(%22forceInner%22%2C%20%7BcreateScript%3A%20(to_escape)%20%3D%3E%20to_escape%7D)%3B%0A%20%20return%20policy.createScript(script)%3B%0A%7D%3B%0A%0A%0Aconst%20setInnerHTML%20%3D%20function(elm%2C%20html)%20%7B%0A%20%20elm.innerHTML%20%3D%20escapeHTML(html)%3B%0A%20%20Array.from(elm.querySelectorAll('script')).forEach(%20oldScript%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20newScript%20%3D%20document.createElement('script')%3B%0A%20%20%20%20%20%20Array.from(oldScript.attributes).forEach(%20attr%20%3D%3E%20newScript.setAttribute(attr.name%2C%20attr.value)%20)%3B%0A%20%20%20%20%20%20newScript.text%20%3D%20escapeScript(oldScript.innerHTML)%3B%0A%20%20%20%20%20%20oldScript.parentNode.replaceChild(newScript%2C%20oldScript)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%0Aconst%20run%20%3D%20async%20function()%20%7B%0A%20%20if%20(!isChartJsLoaded)%20%7B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20const%20results_table_container%20%3D%20document.querySelector('bq-tab-content%3Anot(.cfc-hidden)%20bq-results-table')%3B%0A%20%20if%20(!results_table_container)%20%7B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20const%20cells%20%3D%20results_table_container.querySelectorAll('td%20div%3Anot(.cfc-flex-container)')%3B%0A%20%20if%20(cells.length%20!%3D%3D%201)%20%7B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20const%20cell%20%3D%20cells%5B0%5D%3B%0A%20%20const%20content%20%3D%20cell.innerText%3B%0A%20%20if%20(!content.startsWith(%22%3Chtml%22))%20%7B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20if%20(content.endsWith(%22...%22))%20%7B%0A%20%20%20%20cell.nextElementSibling.firstElementChild.click()%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20const%20html%20%3D%20%60%3Csection%20class%3D%22section%22%3E%24%7Bcontent%7D%3C%2Fsection%3E%60%0A%20%20setInnerHTML(results_table_container%2C%20html)%3B%0A%7D%3B%0A%0A%0Aconst%20loadBulmaCss%20%3D%20function()%20%7B%0A%20%20const%20bulma%20%3D%20document.createElement('link')%3B%0A%20%20bulma.setAttribute('rel'%2C%20'stylesheet')%3B%0A%20%20bulma.setAttribute('href'%2C%20'https%3A%2F%2Fcdn.jsdelivr.net%2Fnpm%2Fbulma%400.9.4%2Fcss%2Fbulma.min.css')%3B%0A%20%20document.head.appendChild(bulma)%3B%0A%7D%3B%0A%0A%0Aconst%20loadChartjs%20%3D%20function()%20%7B%0A%20%20fetch('https%3A%2F%2Fcdnjs.cloudflare.com%2Fajax%2Flibs%2FChart.js%2F3.9.1%2Fchart.min.js')%0A%20%20.then((response)%20%3D%3E%20response.text())%0A%20%20.then((text)%20%3D%3E%20%7B%0A%20%20%20%20const%20script%20%3D%20document.createElement('script')%3B%0A%20%20%20%20script.text%20%3D%20escapeScript(text)%3B%0A%20%20%20%20document.head.appendChild(script)%3B%0A%20%20%20%20isChartJsLoaded%20%3D%20true%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%0A%0A%0AloadBulmaCss()%3B%0AloadChartjs()%3B%0AsetInterval(run%2C%20100)%3B%7D)()%3B">bigfunctions</a>
      - Go to BigQuery console
      - Click on the installed bookmarklet
      - (you will have to click on the bookmarklet each time you go to BigQuery console)
      - Run the query below in the console.
      - Open the result of the latest query
      - And the result will be shown as a nice html content.

      ```sql
      call bigfunctions.eu.explore_column("bigfunctions.eu.natality.weight_pounds");
      select '<html>' || html || '</html>' from bigfunction_result;
      ```

      Below this is explained in a video:

      ![bookmarklet usage](/bigfunctions/site/assets/bookmarklet_usage.gif)



arguments:
  - name: fully_qualified_column
    type: string
examples:
  - description: ""
    arguments:
      - '"{BIGFUNCTIONS_DATASET}.natality.weight_pounds"'
    screenshot: explore_column.png
code: |
  declare project, dataset, table, column, data_type, query string;
  declare context json;
  declare nbins string default '10';
  declare nbins_top_values string default '100';

  declare parts array<string> default split(replace(fully_qualified_column, '`', ''), '.');
  set project = parts[offset(0)];
  set dataset = parts[offset(1)];
  set table = parts[offset(2)];
  set column = parts[offset(3)];



  execute immediate replace(replace(replace(replace(
    '''
    select data_type
    from `{{project}}.{{dataset}}.INFORMATION_SCHEMA.COLUMNS`
    where
      table_name = '{{table}}'
      and column_name = '{{column}}'
    ''',
    '{{project}}', project),
    '{{dataset}}', dataset),
    '{{table}}', table),
    '{{column}}', column
  ) into data_type;

  set query = '''
    create or replace temp table bigfunction_result as

    with

    stats as (
      select
        count(*) as row_count,
        count(distinct `{{column}}`) as distinct_count,
        count(distinct `{{column}}`) / count(*) as distinct_ratio,
        count(*) - count(`{{column}}`) as missing_count,
        (count(*) - count(`{{column}}`)) / count(*) as missing_ratio,
        {% if data_type in ['FLOAT64', 'INT64', 'NUMERIC'] %}cast(min(`{{column}}`) as float64){% else %}null{% endif %} as min,
        {% if data_type in ['FLOAT64', 'INT64', 'NUMERIC'] %}cast(avg(`{{column}}`) as float64){% else %}null{% endif %} as mean,
        {% if data_type in ['FLOAT64', 'INT64', 'NUMERIC'] %}cast(max(`{{column}}`) as float64){% else %}null{% endif %} as max,
      from `{{project}}.{{dataset}}.{{table}}`
    ),

    {% if data_type in ['FLOAT64', 'NUMERIC'] %}
      hist_bins as (
        select
          i,
          `min` + i/{{nbins}}. * (`max`-`min`)  as low,
          `min` + (i+1)/{{nbins}}. * (`max`-`min`) + if(i={{nbins}}-1, 1, 0)  as up,
          (
            '[' ||
              cast(round(`min` + i/{{nbins}}. * (`max`-`min`), 2) as string) || ', ' ||
              cast(round(`min` + (i+1)/{{nbins}}. * (`max`-`min`), 2) as string) ||
            if(i={{nbins}}-1, ']', '[')
          ) as label,
          'real' as bin_mode,
        from stats, unnest(generate_array(0, {{nbins}})) i
        where i < {{nbins}}
      ),

      hist_counts as (
        select
          bin.i,
          count(*) as row_count,
        from `{{project}}.{{dataset}}.{{table}}`
        inner join hist_bins as bin
        on `{{column}}` >= bin.low and `{{column}}` < bin.up
        group by i
      ),

      hist as (
        select array_agg(
          struct(hist_bins.label as x, cast(ifnull(row_count, 0) as float64) as y)
          order by i
        ) hist
        from hist_bins
        left join hist_counts using(i)
      )

    {% elif data_type == 'INT64' %}
      hist_bins_for_reals as (
        select
          i,
          `min` + i/{{nbins}}. * (`max`-`min`)  as low,
          `min` + (i+1)/{{nbins}}. * (`max`-`min`) + if(i={{nbins}}-1, 1, 0)  as up,
          (
            '[' ||
              cast(round(`min` + i/{{nbins}}. * (`max`-`min`), 2) as string) || ', ' ||
              cast(round(`min` + (i+1)/{{nbins}}. * (`max`-`min`), 2) as string) ||
            if(i={{nbins}}-1, ']', '[')
          ) as label,
          'real' as bin_mode,
        from stats, unnest(generate_array(0, {{nbins}})) i
        where i < {{nbins}}
      ),

      hist_bins_for_integers as (
        select
          i,
          i - 0.5  as low,
          i + 0.5  as up,
          cast(i as string) as label,
          'integer' as bin_mode,
        from stats, unnest(generate_array(stats.min, least(stats.max, stats.min + 60))) i
      ),

      hist_bins as (
        select * from hist_bins_for_reals
        where bin_mode = if('{{data_type}}' = 'INT64' and (select count(*) from hist_bins_for_integers) <= 60, 'integer', 'real')
        union all
        select * from hist_bins_for_integers
        where bin_mode = if('{{data_type}}' = 'INT64' and (select count(*) from hist_bins_for_integers) <= 60, 'integer', 'real')
      ),

      hist_counts as (
        select
          bin.i,
          count(*) as row_count,
        from `{{project}}.{{dataset}}.{{table}}`
        inner join hist_bins as bin
        on `{{column}}` >= bin.low and `{{column}}` < bin.up
        group by i
      ),

      hist as (
        select array_agg(
          struct(hist_bins.label as x, cast(ifnull(row_count, 0) as float64) as y)
          order by i
        ) hist
        from hist_bins
        left join hist_counts using(i)
      )


    {% else %}
      top_values as (
        select
          {% if data_type in ['TIMESTAMP', 'DATETIME'] %}
            cast(date(`{{column}}`) as string) as value,
          {% else %}
            cast(`{{column}}` as string) as value,
          {% endif %}
          count(*) as value_count,
          count(*) * 1. / (select row_count from stats) as value_ratio,
        from `{{project}}.{{dataset}}.{{table}}`
        where {{column}} is not null
        group by 1
        limit {{nbins_top_values}}
      ),

      hist as (
        select array_agg(
          struct(value as x, cast(value_count as float64) as y)
          order by value_count desc
        ) hist
        from top_values
      )
    {% endif %}

    select to_json(struct(
      '{{column}}' as name,
      '{{data_type}}' as data_type,
      (select stats from stats) as stats,
      (select hist.hist from hist) as hist,
      (select {BIGFUNCTIONS_DATASET}.chart(hist.hist, 'bar', 'value_count') from hist) as hist_html
    )) as json;
  ''';

  set context = to_json(struct(
    project as project,
    dataset as dataset,
    table as table,
    column as column,
    data_type as data_type,
    nbins as nbins,
    nbins_top_values as nbins_top_values
  ));

  set query = (select {BIGFUNCTIONS_DATASET}.render_string(query, to_json_string(context)));
  execute immediate query;
template: |
  <div class="container">
    <div class="box">
      <p class="is-size-4 mb-6 mt-4">Column <code>{{ name }}</code> <code>{{ data_type }}</code></p>
        <div class="columns">
          <div class="column is-one-quarter">
            <table class="table is-narrow">
              {% if data_type not in ['STRING', 'BOOL'] %}
                <tr><th class="has-text-weight-bold">min           </th><td>{{ stats.min            | add_thousands_separators_to_integers }}</td></tr>
                <tr><th class="has-text-weight-bold">mean          </th><td>{{ stats.mean           | add_thousands_separators_to_integers }}</td></tr>
                <tr><th class="has-text-weight-bold">max           </th><td>{{ stats.max            | add_thousands_separators_to_integers }}</td></tr>
              {% endif %}
              {% if data_type != 'BOOL' %}
                <tr><th class="has-text-weight-bold">distinct_count</th><td>{{ stats.distinct_count | add_thousands_separators_to_integers }}</td></tr>
                {% if stats.distinct_ratio > 0.001 %}
                  <tr><th class="has-text-weight-bold">distinct_ratio</th><td {% if stats.distinct_ratio == 1 %}class="has-background-success-light"{% elif stats.distinct_ratio > 0.9 %}class="has-background-danger-light"{% endif %}>{{ stats.distinct_ratio | as_percentage }}</td></tr>
                {% endif %}
              {% endif %}
              <tr><th class="has-text-weight-bold">missing_count </th><td {% if stats.missing_ratio == 0 %}class="has-background-success-light"{% endif %}>{{ stats.missing_count  | add_thousands_separators_to_integers }}</td></tr>
              {% if stats.missing_count != 0 %}
                <tr><th class="has-text-weight-bold">missing_ratio </th><td class="has-background-danger-light">{{ stats.missing_ratio  | as_percentage }}</td></tr>
              {% endif %}
              <tr><th class="has-text-weight-bold">row_count     </th><td>{{ stats.row_count      | add_thousands_separators_to_integers }}</td></tr>
            </table>
          </div>
          <div class="column">
            {{ hist_html|safe }}
          </div>
        </div>
    </div>
  </div>

