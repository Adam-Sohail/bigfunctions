type: function_py
category: transform_string
author:
  name: Paul Marcombes
  url: https://www.linkedin.com/in/paul-marcombes
  avatar_url: "https://lh3.googleusercontent.com/a-/ACB-R5RDf2yxcw1p_IYLCKmiUIScreatDdhG8B83om6Ohw=s260"
description: |
  Get `country_code` of `ip`

  > This functions uses IP address data powered by [IPinfo](https://ipinfo.io)
  > and released under [Creative Commons Attribution-ShareAlike 4.0 International License](https://creativecommons.org/licenses/by-sa/4.0/).
  > You are required to attribute IPinfo to use their free datasets.
  > The attribution requirements can be met by giving their service credit as your data source.
  > Simply place a link to IPinfo on the website, application, or social media account that uses their data.
arguments:
  - name: ip
    type: string
output:
  name: country_code
  type: string
examples:
  - description: ""
    arguments:
      - "'152.216.7.110'"
    output: 'US'
init_code: |
  import datetime
  import os
  import urllib.request
  import maxminddb

  with open('/storage/hello.txt', 'w', encoding='utf-8') as f:
    f.write('world')
  print(os.path.getmtime('/storage/hello.txt'))

  with open('/storage/hello.txt', 'w', encoding='utf-8') as f:
    f.write('foo')
  print(os.path.getmtime('/storage/hello.txt'))

  with open('/storage/foo/hello.txt', 'w', encoding='utf-8') as f:
    f.write('world')

  filename = '/tmp/db.mmdb'
  today = datetime.datetime.now().strftime('%Y-%m-%d')

  blob = storage.bucket.get_blob(filename.lstrip('/'))
  if blob is not None and blob.updated.strftime('%Y-%m-%d') == today:
    blob.download_to_filename(filename)
    print('downloaded file from bucket as it is up to date')
  else:
    url = f'https://ipinfo.io/data/free/country.mmdb?token={ipinfo_token}'
    try:
      urllib.request.urlretrieve(url, filename)
      print('downloaded file from ipinfo')
      assert os.path.isfile(filename)
    except:
      if blob is not None:
        blob.download_to_filename(filename)
        print('error in downloading file from ipinfo. Downloaded latest file from bucket')
    else:
      blob = storage.bucket.blob(filename.lstrip('/'))
      blob.upload_from_filename(filename)
      print('uploaded file to bucket')

  db = None
  if os.path.isfile(filename):
    db = maxminddb.open_database("/tmp/db.mmdb")
code: |
  assert db, "Could NOT load database"
  try:
    result = db.get(ip)
  except:
    return 'ZZ'
  if not result:
    return 'ZZ'
  return result['country']
requirements: |
  google-cloud-storage
  maxminddb
secrets:
  - name: ipinfo_token
    description: IP Info Token
    documentation_link: https://ipinfo.io/account/token
cloud_run:
  memory: 512Mi
  max_instances: 10
  add_volume: '"name=storage,type=cloud-storage,bucket=bigfunctions_storage"'
  add_volume_mount: '"volume=storage,mount-path=/storage"'

