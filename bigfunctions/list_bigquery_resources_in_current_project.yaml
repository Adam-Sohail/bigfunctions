type: procedure
category: utils
author:
  name: Paul Marcombes
  url: https://www.linkedin.com/in/paul-marcombes
  avatar_url: "https://lh3.googleusercontent.com/a-/ACB-R5RDf2yxcw1p_IYLCKmiUIScreatDdhG8B83om6Ohw=s260"
description: |
  List BigQuery resources
  in current Google Cloud `project` enriched with their BigQuery usage in current `project`.

  BigQuery resources include tables, views, columns, datasets, users.

  For each data asset, a `popularity` score is computed. For example, for a table, it is equal to the number of distinct users which read the table in the latest 30 days using `execution_projects`.

  The result is written into `bigfunction_result` temporary table which has the following columns:

  - `id`: unique identifier of the data asset
  - `type`: asset type such as tables, views, datasets, users, etc.
  - `name`: asset name
  - `description`: asset description
  - `popularity`: popularity as float64 (the higher the more popular)
  - `details`: a json blob with asset additional details such as the tables of a dataset or the users of a table.
examples:
  - description: ""
    arguments:
      - "'you-bigquery-project'"
code: |
  declare project, dataset, table, query string;
  declare parts array<string> default split(replace(fully_qualified_table, '`', ''), '.');
  set project = parts[offset(0)];
  set dataset = parts[offset(1)];
  set table = parts[offset(2)];

  set query = '''
    create or replace temp table bigfunction_result as
    select *
    from `{{project}}.{{dataset}}.INFORMATION_SCHEMA.COLUMNS`
    where table_name = '{{table}}'
  ''' ;
  execute immediate replace(replace(replace(query, "{{project}}", project), "{{dataset}}", dataset), "{{table}}", table);
