create or replace function TEMP.bbb(start_date datetime, end_date datetime, country_code string, weekend_days string) as ((

with

public_holidays_between_dates_excluding_weekends as (
  select count(*) as nb
  from bigfunctions.eu.holidays
  where
    holidays.date > date(start_date) and holidays.date < date(end_date)
    and holidays.country = country_code
    and not regexp_contains(upper(format_date('%A', holidays.date)), weekend_days)
)

-- weekend_days_between_dates as (
--   select countif(upper(format_date('%A', holidays.date)) != 'SATURDAY') as nb
--   from unnest(generate_date_array(start_date, end_date))
--   where
--     holidays.date > start_date and holidays.date < end_date
--     and holidays.country = country_code
-- ),

select public_holidays_between_dates_excluding_weekends.nb
from public_holidays_between_dates_excluding_weekends

));

select TEMP.bbb(cast(current_date as datetime), cast(end_date as datetime), 'FR', 'SATURDAY|SUNDAY')
from unnest(generate_date_array(current_date + 1, current_date + 100)) as end_date

