declare date1, date2 datetime;
declare country string;
declare weekend_days array<string>;

set date1 = datetime_sub(current_datetime, interval 90 day);
set date2 = current_datetime;
set country = 'FR';
set weekend_days = ['SATURDAY', 'SUNDAY'];


with dates as (
  select
    date,
    case
      when date = date(date1) then 1 - (datetime_diff(date1, datetime_trunc(date1, day), second) / 86400)
      when date = date(date2) then (datetime_diff(date2, datetime_trunc(date2, day), second) / 86400)
      else 1
    end as day_ratio,
    bigfunctions.eu.is_public_holiday(date, country) as is_public_holiday,
    upper(format_date('%A', date)) in (select * from unnest(weekend_days)) as is_weekend,
  from unnest(generate_date_array(date(date1), date(date2))) date
)

select
  if(
    date(date1) = date(date2),
    sum(datetime_diff(date2, date1, second) / 86400 * cast(not is_public_holiday and not is_weekend as int64)),
    sum(day_ratio * cast(not is_public_holiday and not is_weekend as int64))
  ) as nb_days
from dates